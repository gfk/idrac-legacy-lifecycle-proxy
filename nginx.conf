server {
    listen 80;
    server_name _;

    # 1. Fix the "Path Mismatch" (The 404 error)
    # iDRAC requests /Catalog.xml.gz -> We rewrite to /catalog/Catalog.xml.gz
    # The regex [cC]atalog handles both "Catalog" and "catalog" variations
    rewrite ^/[cC]atalog\.(.*)$ /catalog/Catalog.$1 break;

    location / {
        # Google DNS for resolving dl.dell.com dynamically
        resolver 8.8.8.8 ipv6=off;

        # The target: Dell's HTTPS CDN
        proxy_pass https://dl.dell.com;

        # CRITICAL: Ensures Nginx sends the correct SNI hostname in the TLS handshake
        proxy_ssl_server_name on;

        # Pass the correct Host header to Dell so they know what site we want
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Host dl.dell.com;

        # meaningful timeouts for large firmware files
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;

        # Hide the fact that we are proxying (optional, but cleaner)
        proxy_hide_header X-Frame-Options;

        # If iDRAC checks the root to verify connectivity, give it a 200 OK directly
        # This prevents the request from even going to Dell
        if ($request_method = HEAD) {
            return 200;
        }
    }
}
